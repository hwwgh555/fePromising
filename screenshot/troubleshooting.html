<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Capture API æ•…éšœæ’é™¤æŒ‡å—</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #e74c3c;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .problem-box {
            background: #ffebee;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .problem-box h3 {
            color: #e74c3c;
            margin-top: 0;
        }

        .solution-box {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .solution-box h3 {
            color: #4caf50;
            margin-top: 0;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box h3 {
            color: #f57c00;
            margin-top: 0;
        }

        .info-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h3 {
            color: #1976d2;
            margin-top: 0;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.test {
            background: linear-gradient(45deg, #4caf50, #2e7d32);
        }

        .btn.alternative {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            margin: 15px 0;
        }

        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }

        .checklist {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 20px;
            margin: 20px 0;
        }

        .checklist ul {
            margin: 0;
            padding-left: 20px;
        }

        .checklist li {
            margin: 8px 0;
        }

        .alternative-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .method-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .method-card h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-size: 14px;
        }

        .browser-support {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .browser-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .browser-item.supported {
            border-color: #4caf50;
            background: #e8f5e8;
        }

        .browser-item.limited {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .browser-item.not-supported {
            border-color: #f44336;
            background: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Screen Capture API æ•…éšœæ’é™¤æŒ‡å—</h1>
        
        <div class="problem-box">
            <h3>âŒ å¸¸è§é—®é¢˜ï¼šæ— æ³•é€‰æ‹©è‡ªå·±çš„é¡µé¢æ ‡ç­¾</h3>
            <p>åœ¨ä½¿ç”¨ <code>getDisplayMedia()</code> æ—¶ï¼Œå¼¹å‡ºçš„é€‰æ‹©æ¡†ä¸­æ²¡æœ‰æ˜¾ç¤ºå½“å‰é¡µé¢çš„æ ‡ç­¾é¡µé€‰é¡¹ã€‚</p>
            <p><strong>è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„é™åˆ¶ï¼Œä¸æ˜¯æ‚¨çš„ä»£ç é—®é¢˜ï¼</strong></p>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ é—®é¢˜åŸå› åˆ†æ</h3>
            <ul>
                <li><strong>æµè§ˆå™¨å®‰å…¨é™åˆ¶</strong>ï¼šéƒ¨åˆ†æµè§ˆå™¨ä¸ºé˜²æ­¢æ¶æ„è„šæœ¬ï¼Œé™åˆ¶é¡µé¢æˆªå›¾è‡ªå·±</li>
                <li><strong>HTTPSè¦æ±‚</strong>ï¼šScreen Capture API é€šå¸¸éœ€è¦HTTPSç¯å¢ƒæ‰èƒ½å®Œæ•´å·¥ä½œ</li>
                <li><strong>æµè§ˆå™¨ç‰ˆæœ¬</strong>ï¼šä¸åŒç‰ˆæœ¬çš„æµè§ˆå™¨è¡Œä¸ºå¯èƒ½ä¸åŒ</li>
                <li><strong>æµè§ˆå™¨è®¾ç½®</strong>ï¼šç”¨æˆ·çš„éšç§è®¾ç½®å¯èƒ½å½±å“åŠŸèƒ½</li>
                <li><strong>é¡µé¢çŠ¶æ€</strong>ï¼šæŸäº›é¡µé¢çŠ¶æ€ä¸‹å¯èƒ½æ— æ³•è¢«é€‰æ‹©</li>
            </ul>
        </div>

        <div class="checklist">
            <h3>âœ… æ•…éšœæ’é™¤æ¸…å•</h3>
            <ul>
                <li>â˜ ç¡®è®¤ä½¿ç”¨HTTPSåè®®ï¼ˆ<code>https://</code>ï¼‰è®¿é—®é¡µé¢</li>
                <li>â˜ å°è¯•ä¸åŒçš„æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeï¼‰</li>
                <li>â˜ ç¡®è®¤æµè§ˆå™¨ç‰ˆæœ¬æ˜¯æœ€æ–°çš„</li>
                <li>â˜ æ£€æŸ¥æµè§ˆå™¨çš„æ‘„åƒå¤´/å±å¹•å½•åˆ¶æƒé™è®¾ç½®</li>
                <li>â˜ å°è¯•åœ¨æ— ç—•/éšç§æ¨¡å¼ä¸‹è¿è¡Œ</li>
                <li>â˜ ç¡®è®¤é¡µé¢æ²¡æœ‰è¢«å…¶ä»–æ‰©å±•ç¨‹åºé˜»æ­¢</li>
            </ul>
        </div>

        <div class="warning-box">
            <h3>âš ï¸ æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•æ‚¨çš„æµè§ˆå™¨æ˜¯å¦æ”¯æŒé€‰æ‹©å½“å‰æ ‡ç­¾é¡µï¼š</p>
            <button class="btn test" onclick="testCurrentTabCapture()">ğŸ§ª æµ‹è¯•æˆªå›¾å½“å‰æ ‡ç­¾é¡µ</button>
            <div id="test-status" class="status info">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æ£€æµ‹</div>
        </div>

        <div class="browser-support">
            <div class="browser-item supported">
                <h4>âœ… Chrome 72+</h4>
                <p>å®Œå…¨æ”¯æŒï¼Œé€šå¸¸å¯ä»¥é€‰æ‹©å½“å‰æ ‡ç­¾é¡µ</p>
            </div>
            <div class="browser-item limited">
                <h4>âš ï¸ Firefox 66+</h4>
                <p>æ”¯æŒä½†å¯èƒ½æœ‰é™åˆ¶</p>
            </div>
            <div class="browser-item supported">
                <h4>âœ… Edge 79+</h4>
                <p>åŸºäºChromiumï¼Œæ”¯æŒè‰¯å¥½</p>
            </div>
            <div class="browser-item limited">
                <h4>âš ï¸ Safari 13+</h4>
                <p>æ”¯æŒä½†åŠŸèƒ½å—é™</p>
            </div>
        </div>

        <div class="solution-box">
            <h3>âœ… è§£å†³æ–¹æ¡ˆ</h3>
            
            <h4>æ–¹æ¡ˆ1ï¼šä½¿ç”¨HTTPS</h4>
            <p>å°†é¡µé¢éƒ¨ç½²åˆ°HTTPSç¯å¢ƒï¼Œæˆ–ä½¿ç”¨æœ¬åœ°HTTPSæœåŠ¡å™¨ï¼š</p>
            <pre><code># ä½¿ç”¨http-serveråˆ›å»ºHTTPSæœ¬åœ°æœåŠ¡å™¨
npm install -g http-server
http-server -S -C cert.pem -K key.pem</code></pre>

            <h4>æ–¹æ¡ˆ2ï¼šåˆ‡æ¢æµè§ˆå™¨</h4>
            <p>å°è¯•åœ¨ä¸åŒæµè§ˆå™¨ä¸­æµ‹è¯•ï¼ŒChromeé€šå¸¸æ”¯æŒæœ€å¥½ã€‚</p>

            <h4>æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨é€‰æ‹©"æ•´ä¸ªå±å¹•"</h4>
            <p>åœ¨é€‰æ‹©æ¡†ä¸­é€‰æ‹©"æ•´ä¸ªå±å¹•"è€Œä¸æ˜¯æ ‡ç­¾é¡µï¼Œç„¶åè£å‰ªéœ€è¦çš„åŒºåŸŸã€‚</p>
        </div>

        <div class="alternative-methods">
            <div class="method-card">
                <h4>ğŸ¨ æ›¿ä»£æ–¹æ¡ˆ1ï¼šhtml2canvas</h4>
                <p>ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ç›´æ¥æˆªå›¾DOMå…ƒç´ </p>
                <button class="btn alternative" onclick="demonstrateHtml2canvas()">æ¼”ç¤ºhtml2canvas</button>
                <div id="html2canvas-demo" style="margin-top: 10px;"></div>
            </div>

            <div class="method-card">
                <h4>ğŸ“ æ›¿ä»£æ–¹æ¡ˆ2ï¼šDOM to SVG</h4>
                <p>å°†DOMè½¬æ¢ä¸ºSVGå†å¯¼å‡ºä¸ºå›¾ç‰‡</p>
                <button class="btn alternative" onclick="demonstrateDomToSvg()">æ¼”ç¤ºDOMè½¬SVG</button>
                <div id="svg-demo" style="margin-top: 10px;"></div>
            </div>

            <div class="method-card">
                <h4>ğŸ–¼ï¸ æ›¿ä»£æ–¹æ¡ˆ3ï¼šCanvasæˆªå›¾</h4>
                <p>ä½¿ç”¨Canvas APIé‡ç»˜é¡µé¢å†…å®¹</p>
                <button class="btn alternative" onclick="demonstrateCanvasCapture()">æ¼”ç¤ºCanvasæˆªå›¾</button>
                <div id="canvas-demo" style="margin-top: 10px;"></div>
            </div>
        </div>

        <div class="info-box">
            <h3>ğŸ’¡ æœ€ä½³å®è·µå»ºè®®</h3>
            <ul>
                <li><strong>å¤šé‡æ–¹æ¡ˆ</strong>ï¼šåŒæ—¶æä¾›å¤šç§æˆªå›¾æ–¹å¼ç»™ç”¨æˆ·é€‰æ‹©</li>
                <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä¼˜é›…åœ°å¤„ç†APIè°ƒç”¨å¤±è´¥çš„æƒ…å†µ</li>
                <li><strong>ç”¨æˆ·æç¤º</strong>ï¼šæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·å¦‚ä½•æ“ä½œ</li>
                <li><strong>åŠŸèƒ½æ£€æµ‹</strong>ï¼šåœ¨ä½¿ç”¨å‰æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒ</li>
                <li><strong>å¤‡ç”¨æ–¹æ¡ˆ</strong>ï¼šå½“Screen Captureä¸å¯ç”¨æ—¶ï¼Œæä¾›å…¶ä»–æˆªå›¾æ–¹æ³•</li>
            </ul>
        </div>

        <div class="solution-box">
            <h3>ğŸ”„ å®Œæ•´çš„é”™è¯¯å¤„ç†ä»£ç ç¤ºä¾‹</h3>
            <pre><code>async function capturePageWithFallback() {
    try {
        // é¦–å…ˆå°è¯•Screen Capture API
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: { width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        
        console.log('âœ… Screen CaptureæˆåŠŸ');  
        return await processVideoStream(stream);
        
    } catch (error) {
        console.warn('Screen Captureå¤±è´¥:', error.message);
        
        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„å¤„ç†æ–¹æ¡ˆ
        if (error.name === 'NotAllowedError') {
            alert('ç”¨æˆ·æ‹’ç»äº†å±å¹•æ•è·æƒé™ï¼Œè¯·å°è¯•å…¶ä»–æˆªå›¾æ–¹å¼');
        } else if (error.name === 'NotFoundError') {
            alert('æœªæ‰¾åˆ°å¯æ•è·çš„å±å¹•æºï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨é™åˆ¶');
        }
        
        // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        return await fallbackScreenshot();
    }
}

async function fallbackScreenshot() {
    // å¤‡ç”¨æ–¹æ¡ˆ1ï¼šä½¿ç”¨html2canvas
    if (window.html2canvas) {
        return await html2canvas(document.body);
    }
    
    // å¤‡ç”¨æ–¹æ¡ˆ2ï¼šä½¿ç”¨Canvasé‡ç»˜
    return await canvasScreenshot();
}</code></pre>
        </div>
    </div>

    <script>
        // æµ‹è¯•å½“å‰æ ‡ç­¾é¡µæ•è·åŠŸèƒ½
        async function testCurrentTabCapture() {
            const statusEl = document.getElementById('test-status');
            
            try {
                statusEl.textContent = 'ğŸ§ª æ­£åœ¨æµ‹è¯•æµè§ˆå™¨æ”¯æŒ...';
                statusEl.className = 'status info';

                // æ£€æŸ¥APIæ˜¯å¦å­˜åœ¨
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒ Screen Capture API');
                }

                statusEl.textContent = 'ğŸ“‹ è¯·åœ¨å¼¹å‡ºæ¡†ä¸­æŸ¥çœ‹æ˜¯å¦æœ‰å½“å‰æ ‡ç­¾é¡µé€‰é¡¹...';
                
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: { ideal: 1920 }, height: { ideal: 1080 } }
                });

                statusEl.textContent = 'âœ… æµ‹è¯•æˆåŠŸï¼æ‚¨çš„æµè§ˆå™¨æ”¯æŒå±å¹•æ•è·åŠŸèƒ½';
                statusEl.className = 'status success';

                // ç«‹å³åœæ­¢æµ
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                
                let message = 'âŒ æµ‹è¯•å¤±è´¥: ';
                if (error.name === 'NotAllowedError') {
                    message += 'ç”¨æˆ·æ‹’ç»äº†æƒé™æˆ–æµè§ˆå™¨é˜»æ­¢äº†æ“ä½œ';
                } else if (error.name === 'NotFoundError') {
                    message += 'æœªæ‰¾åˆ°å¯æ•è·çš„åª’ä½“æº';
                } else if (error.name === 'NotSupportedError') {
                    message += 'æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½';
                } else {
                    message += error.message;
                }
                
                statusEl.textContent = message;
                statusEl.className = 'status error';
            }
        }

        // æ¼”ç¤ºhtml2canvasæ›¿ä»£æ–¹æ¡ˆ
        function demonstrateHtml2canvas() {
            const demoEl = document.getElementById('html2canvas-demo');
            demoEl.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    <p><strong>html2canvas</strong> æ˜¯ä¸€ä¸ªæµè¡Œçš„DOMæˆªå›¾åº“</p>
                    <code>npm install html2canvas</code>
                    <p>ä¼˜ç‚¹ï¼šç›´æ¥æˆªå›¾DOMï¼Œæ— éœ€ç”¨æˆ·æˆæƒ</p>
                    <p>ç¼ºç‚¹ï¼šæŸäº›CSSæ ·å¼å¯èƒ½æ— æ³•å®Œç¾æ¸²æŸ“</p>
                </div>
            `;
        }

        // æ¼”ç¤ºDOMè½¬SVGæ›¿ä»£æ–¹æ¡ˆ
        function demonstrateDomToSvg() {
            const demoEl = document.getElementById('svg-demo');
            demoEl.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    <p><strong>DOM to SVG</strong> å°†DOMå…ƒç´ è½¬æ¢ä¸ºSVG</p>
                    <p>ä¼˜ç‚¹ï¼šçŸ¢é‡å›¾å½¢ï¼Œè´¨é‡é«˜ï¼Œæ–‡ä»¶å°</p>
                    <p>ç¼ºç‚¹ï¼šå¤æ‚æ ·å¼æ”¯æŒæœ‰é™</p>
                </div>
            `;
        }

        // æ¼”ç¤ºCanvasæˆªå›¾æ›¿ä»£æ–¹æ¡ˆ
        function demonstrateCanvasCapture() {
            const demoEl = document.getElementById('canvas-demo');
            demoEl.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    <p><strong>Canvasé‡ç»˜</strong> æ‰‹åŠ¨åœ¨Canvasä¸Šé‡ç»˜å†…å®¹</p>
                    <p>ä¼˜ç‚¹ï¼šå®Œå…¨æ§åˆ¶ï¼Œæ€§èƒ½å¥½</p>
                    <p>ç¼ºç‚¹ï¼šéœ€è¦æ‰‹åŠ¨å®ç°æ‰€æœ‰ç»˜åˆ¶é€»è¾‘</p>
                </div>
            `;
        }

        // æ£€æµ‹å½“å‰ç¯å¢ƒ
        function detectEnvironment() {
            const isHTTPS = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (!isHTTPS && !isLocalhost) {
                const warningEl = document.createElement('div');
                warningEl.className = 'warning-box';
                warningEl.innerHTML = `
                    <h3>âš ï¸ å½“å‰ç¯å¢ƒè­¦å‘Š</h3>
                    <p>æ‚¨æ­£åœ¨éHTTPSç¯å¢ƒä¸‹è®¿é—®æ­¤é¡µé¢ï¼Œè¿™å¯èƒ½å¯¼è‡´Screen Capture APIåŠŸèƒ½å—é™ã€‚</p>
                    <p><strong>å»ºè®®ï¼š</strong>ä½¿ç”¨HTTPSåè®®æˆ–localhostè®¿é—®ä»¥è·å¾—å®Œæ•´åŠŸèƒ½ã€‚</p>
                `;
                document.querySelector('.container').insertBefore(warningEl, document.querySelector('h1').nextSibling);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', detectEnvironment);
    </script>
</body>
</html> 