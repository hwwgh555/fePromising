<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>截图和图像编辑工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 80vh;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .tool-section {
            margin-bottom: 30px;
        }

        .tool-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .form-group {
            margin: 10px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="color"] {
            height: 40px;
            padding: 2px;
        }

        .form-group input[type="range"] {
            margin: 10px 0;
        }

        .workspace {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvas-container {
            position: relative;
            margin: 20px 0;
            border: 2px dashed #ced4da;
            border-radius: 8px;
            background: #f8f9fa;
            min-width: 800px;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container.has-image {
            border-style: solid;
            border-color: #667eea;
            background: white;
        }

        #editCanvas {
            max-width: 100%;
            max-height: 70vh;
            cursor: crosshair;
            border-radius: 4px;
        }

        .canvas-placeholder {
            text-align: center;
            color: #6c757d;
            font-size: 1.2em;
        }

        .demo-content {
            margin: 20px 0;
            padding: 30px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            text-align: center;
        }

        .demo-table {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .demo-table th,
        .demo-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .demo-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .demo-table tr:hover {
            background: #f8f9fa;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .status.show {
            transform: translateX(0);
        }

        .status.success {
            background: #28a745;
        }

        .status.error {
            background: #dc3545;
        }

        .status.info {
            background: #17a2b8;
        }

        .text-controls {
            display: none;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
        }

        .text-controls.active {
            display: block;
        }

        .color-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-row input[type="color"] {
            width: 50px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container span {
            min-width: 30px;
            font-weight: 500;
        }

        .target-selector {
            border: 3px solid #ff6b6b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: white;
            animation: highlight 2s infinite;
        }

        @keyframes highlight {
            0%, 100% { border-color: #ff6b6b; }
            50% { border-color: #4ecdc4; }
        }

        .screenshot-preview {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 截图和图像编辑工具</h1>
            <p>支持HTML元素截图、添加文字、绘制图形等功能</p>
        </div>

        <div class="main-content">
            <!-- 侧边栏工具面板 -->
            <div class="sidebar">
                <!-- 截图工具 -->
                <div class="tool-section">
                    <h3>📸 截图工具</h3>
                    <button class="btn" onclick="captureFullPage()">截取整个页面</button>
                    <button class="btn" onclick="captureTargetElement()">截取目标元素</button>
                    <button class="btn" onclick="captureCustomElement()">选择元素截图</button>
                    
                    <div class="form-group">
                        <label>自定义选择器:</label>
                        <input type="text" id="customSelector" placeholder="例如: #myDiv, .className">
                    </div>
                    
                    <div class="form-group">
                        <label>截图质量:</label>
                        <select id="screenshotQuality">
                            <option value="1">标准 (1x)</option>
                            <option value="2">高清 (2x)</option>
                            <option value="3">超高清 (3x)</option>
                        </select>
                    </div>
                </div>

                <!-- 文字编辑工具 -->
                <div class="tool-section">
                    <h3>✏️ 文字工具</h3>
                    <button class="btn" onclick="enableTextMode()">添加文字</button>
                    
                    <div class="text-controls" id="textControls">
                        <div class="form-group">
                            <label>文字内容:</label>
                            <textarea id="textContent" rows="3" placeholder="输入要添加的文字"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>字体大小:</label>
                            <div class="slider-container">
                                <input type="range" id="fontSize" min="12" max="100" value="24">
                                <span id="fontSizeValue">24px</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>字体样式:</label>
                            <select id="fontFamily">
                                <option value="Arial">Arial</option>
                                <option value="Microsoft YaHei">微软雅黑</option>
                                <option value="SimHei">黑体</option>
                                <option value="SimSun">宋体</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>文字颜色:</label>
                            <div class="color-row">
                                <input type="color" id="textColor" value="#000000">
                                <span>文字</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>背景颜色:</label>
                            <div class="color-row">
                                <input type="color" id="textBgColor" value="#ffffff">
                                <input type="checkbox" id="transparentBg" checked>
                                <span>透明</span>
                            </div>
                        </div>
                        
                        <button class="btn secondary" onclick="disableTextMode()">取消文字模式</button>
                    </div>
                </div>

                <!-- 绘制工具 -->
                <div class="tool-section">
                    <h3>🎨 绘制工具</h3>
                    <button class="btn" onclick="enableDrawMode()">自由绘制</button>
                    <button class="btn" onclick="enableRectMode()">绘制矩形</button>
                    <button class="btn" onclick="enableCircleMode()">绘制圆形</button>
                    
                    <div class="form-group">
                        <label>画笔颜色:</label>
                        <input type="color" id="drawColor" value="#ff0000">
                    </div>
                    
                    <div class="form-group">
                        <label>画笔粗细:</label>
                        <div class="slider-container">
                            <input type="range" id="drawWidth" min="1" max="20" value="3">
                            <span id="drawWidthValue">3px</span>
                        </div>
                    </div>
                </div>

                <!-- 操作工具 -->
                <div class="tool-section">
                    <h3>🔧 操作工具</h3>
                    <button class="btn secondary" onclick="clearCanvas()">清空画布</button>
                    <button class="btn secondary" onclick="undoLastAction()">撤销操作</button>
                    <button class="btn" onclick="downloadImage()">下载图片</button>
                    <button class="btn" onclick="uploadToServer()">上传到服务器</button>
                    <button class="btn secondary" onclick="showSavedImages()">查看已保存</button>
                    <button class="btn secondary" onclick="exportAllImages()">批量导出</button>
                    <button class="btn danger" onclick="resetAll()">重置所有</button>
                </div>

                <!-- 服务器设置 -->
                <div class="tool-section">
                    <h3>🌐 服务器设置</h3>
                    <div class="form-group">
                        <label>上传地址:</label>
                        <input type="text" id="uploadUrl" value="http://localhost:3000/api/upload-image" placeholder="输入上传API地址">
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            💡 本地测试: http://localhost:3000/api/upload-image<br>
                            🌐 生产环境: https://your-domain.com/api/upload-image
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>图片标题:</label>
                        <input type="text" id="imageTitle" placeholder="为图片添加标题">
                    </div>
                    
                    <div class="form-group">
                        <label>图片描述:</label>
                        <textarea id="imageDescription" rows="3" placeholder="添加图片描述（可选）"></textarea>
                    </div>
                </div>
            </div>

            <!-- 主工作区 -->
            <div class="workspace">
                <!-- 画布容器 -->
                <div class="canvas-container" id="canvasContainer">
                    <div class="canvas-placeholder" id="canvasPlaceholder">
                        <h3>🎯 点击左侧截图按钮开始</h3>
                        <p>截图后可以在此处进行编辑</p>
                    </div>
                    <canvas id="editCanvas" style="display: none;"></canvas>
                </div>

                <!-- 演示内容区域 -->
                <div class="demo-content target-selector" id="targetElement">
                    <h2>🎯 目标截图区域</h2>
                    <p>这是一个用于演示截图功能的区域</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="width: 100px; height: 100px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); margin: 0 auto; border-radius: 50%;"></div>
                    </div>
                    
                    <table class="demo-table">
                        <thead>
                            <tr>
                                <th>功能</th>
                                <th>状态</th>
                                <th>描述</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>HTML截图</td>
                                <td>✅ 支持</td>
                                <td>可截取任意HTML元素</td>
                            </tr>
                            <tr>
                                <td>添加文字</td>
                                <td>✅ 支持</td>
                                <td>支持自定义字体和颜色</td>
                            </tr>
                            <tr>
                                <td>绘制图形</td>
                                <td>✅ 支持</td>
                                <td>支持自由绘制和几何图形</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态提示 -->
    <div class="status" id="statusMsg"></div>

    <!-- html2canvas 库 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        // 全局变量
        let canvas, ctx;
        let isDrawing = false;
        let currentMode = 'none'; // none, text, draw, rect, circle
        let startX, startY;
        let actionHistory = [];
        let tempCanvas, tempCtx;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('editCanvas');
            ctx = canvas.getContext('2d');
            
            // 创建临时画布用于预览
            tempCanvas = document.createElement('canvas');
            tempCtx = tempCanvas.getContext('2d');
            
            setupEventListeners();
            updateSliderValues();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 画布事件
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleCanvasClick);
            
            // 滑块事件
            document.getElementById('fontSize').addEventListener('input', updateSliderValues);
            document.getElementById('drawWidth').addEventListener('input', updateSliderValues);
        }

        // 更新滑块显示值
        function updateSliderValues() {
            const fontSize = document.getElementById('fontSize').value;
            const drawWidth = document.getElementById('drawWidth').value;
            
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
            document.getElementById('drawWidthValue').textContent = drawWidth + 'px';
        }

        // 显示状态消息
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMsg');
            statusEl.textContent = message;
            statusEl.className = `status ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // 截图功能
        async function captureFullPage() {
            try {
                showStatus('正在截取整个页面...', 'info');
                
                const scale = parseInt(document.getElementById('screenshotQuality').value);
                const captureCanvas = await html2canvas(document.body, {
                    backgroundColor: '#ffffff',
                    scale: scale,
                    useCORS: true,
                    logging: false
                });
                
                loadImageToEditor(captureCanvas);
                showStatus('页面截图完成！', 'success');
            } catch (error) {
                showStatus('截图失败: ' + error.message, 'error');
            }
        }

        async function captureTargetElement() {
            try {
                showStatus('正在截取目标元素...', 'info');
                
                const targetEl = document.getElementById('targetElement');
                const scale = parseInt(document.getElementById('screenshotQuality').value);
                
                const captureCanvas = await html2canvas(targetEl, {
                    backgroundColor: '#ffffff',
                    scale: scale,
                    useCORS: true,
                    logging: false
                });
                
                loadImageToEditor(captureCanvas);
                showStatus('目标元素截图完成！', 'success');
            } catch (error) {
                showStatus('截图失败: ' + error.message, 'error');
            }
        }

        async function captureCustomElement() {
            try {
                const selector = document.getElementById('customSelector').value.trim();
                if (!selector) {
                    showStatus('请输入有效的选择器', 'error');
                    return;
                }
                
                const element = document.querySelector(selector);
                if (!element) {
                    showStatus('找不到指定的元素', 'error');
                    return;
                }
                
                showStatus('正在截取自定义元素...', 'info');
                
                const scale = parseInt(document.getElementById('screenshotQuality').value);
                const captureCanvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: scale,
                    useCORS: true,
                    logging: false
                });
                
                loadImageToEditor(captureCanvas);
                showStatus('自定义元素截图完成！', 'success');
            } catch (error) {
                showStatus('截图失败: ' + error.message, 'error');
            }
        }

        // 将图片加载到编辑器
        function loadImageToEditor(sourceCanvas) {
            // 设置画布尺寸
            canvas.width = sourceCanvas.width;
            canvas.height = sourceCanvas.height;
            
            // 设置临时画布尺寸
            tempCanvas.width = sourceCanvas.width;
            tempCanvas.height = sourceCanvas.height;
            
            // 清空并绘制截图
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            // 保存到历史记录
            saveToHistory();
            
            // 显示画布，隐藏占位符
            document.getElementById('canvasPlaceholder').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('canvasContainer').classList.add('has-image');
        }

        // 文字模式
        function enableTextMode() {
            currentMode = 'text';
            document.getElementById('textControls').classList.add('active');
            canvas.style.cursor = 'text';
            showStatus('点击画布添加文字', 'info');
        }

        function disableTextMode() {
            currentMode = 'none';
            document.getElementById('textControls').classList.remove('active');
            canvas.style.cursor = 'default';
        }

        // 绘制模式
        function enableDrawMode() {
            currentMode = 'draw';
            canvas.style.cursor = 'crosshair';
            showStatus('自由绘制模式已启用', 'info');
        }

        function enableRectMode() {
            currentMode = 'rect';
            canvas.style.cursor = 'crosshair';
            showStatus('矩形绘制模式已启用', 'info');
        }

        function enableCircleMode() {
            currentMode = 'circle';
            canvas.style.cursor = 'crosshair';
            showStatus('圆形绘制模式已启用', 'info');
        }

        // 画布事件处理
        function handleCanvasClick(e) {
            if (currentMode === 'text') {
                addTextAtPosition(e);
            }
        }

        function handleMouseDown(e) {
            if (currentMode === 'draw' || currentMode === 'rect' || currentMode === 'circle') {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (canvas.width / rect.width);
                startY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                if (currentMode === 'draw') {
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                }
            }
        }

        function handleMouseMove(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const currentY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if (currentMode === 'draw') {
                // 自由绘制
                ctx.strokeStyle = document.getElementById('drawColor').value;
                ctx.lineWidth = parseInt(document.getElementById('drawWidth').value);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);
            } else if (currentMode === 'rect' || currentMode === 'circle') {
                // 预览几何图形
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(canvas, 0, 0);
                
                tempCtx.strokeStyle = document.getElementById('drawColor').value;
                tempCtx.lineWidth = parseInt(document.getElementById('drawWidth').value);
                
                if (currentMode === 'rect') {
                    const width = currentX - startX;
                    const height = currentY - startY;
                    tempCtx.strokeRect(startX, startY, width, height);
                } else if (currentMode === 'circle') {
                    const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    tempCtx.beginPath();
                    tempCtx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    tempCtx.stroke();
                }
                
                // 临时显示预览
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(tempCanvas, 0, 0);
            }
        }

        function handleMouseUp(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (currentMode === 'rect' || currentMode === 'circle') {
                const rect = canvas.getBoundingClientRect();
                const endX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const endY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                // 恢复原图
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(tempCanvas, 0, 0);
                
                // 绘制最终图形
                ctx.strokeStyle = document.getElementById('drawColor').value;
                ctx.lineWidth = parseInt(document.getElementById('drawWidth').value);
                
                if (currentMode === 'rect') {
                    const width = endX - startX;
                    const height = endY - startY;
                    ctx.strokeRect(startX, startY, width, height);
                } else if (currentMode === 'circle') {
                    const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    ctx.beginPath();
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                }
                
                saveToHistory();
            } else if (currentMode === 'draw') {
                saveToHistory();
            }
        }

        // 添加文字
        function addTextAtPosition(e) {
            const text = document.getElementById('textContent').value.trim();
            if (!text) {
                showStatus('请输入文字内容', 'error');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const fontFamily = document.getElementById('fontFamily').value;
            const textColor = document.getElementById('textColor').value;
            const bgColor = document.getElementById('textBgColor').value;
            const transparent = document.getElementById('transparentBg').checked;
            
            // 设置字体
            ctx.font = `${fontSize}px ${fontFamily}`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            // 测量文字尺寸
            const metrics = ctx.measureText(text);
            const textWidth = metrics.width;
            const textHeight = fontSize;
            
            // 绘制背景（如果不透明）
            if (!transparent) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(x - 5, y - 5, textWidth + 10, textHeight + 10);
            }
            
            // 绘制文字
            ctx.fillStyle = textColor;
            ctx.fillText(text, x, y);
            
            saveToHistory();
            showStatus('文字添加成功', 'success');
        }

        // 历史记录管理
        function saveToHistory() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            actionHistory.push(imageData);
            
            // 限制历史记录数量
            if (actionHistory.length > 10) {
                actionHistory.shift();
            }
        }

        function undoLastAction() {
            if (actionHistory.length > 1) {
                actionHistory.pop(); // 移除当前状态
                const previousState = actionHistory[actionHistory.length - 1];
                ctx.putImageData(previousState, 0, 0);
                showStatus('已撤销上一步操作', 'success');
            } else {
                showStatus('没有可撤销的操作', 'error');
            }
        }

        // 工具函数
        function clearCanvas() {
            if (canvas.width === 0) {
                showStatus('没有可清空的内容', 'error');
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            saveToHistory();
            showStatus('画布已清空', 'success');
        }

        function downloadImage() {
            if (canvas.width === 0) {
                showStatus('没有可下载的图片', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `edited-screenshot-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showStatus('图片下载成功', 'success');
        }

        // 上传图片到服务器
        async function uploadToServer() {
            if (canvas.width === 0) {
                showStatus('没有可上传的图片', 'error');
                return;
            }

            const uploadUrl = document.getElementById('uploadUrl').value.trim();
            const title = document.getElementById('imageTitle').value.trim();
            const description = document.getElementById('imageDescription').value.trim();

            if (!uploadUrl) {
                showStatus('请设置上传地址', 'error');
                return;
            }

            if (!title) {
                showStatus('请输入图片标题', 'error');
                return;
            }

            try {
                showStatus('正在上传图片...', 'info');

                // 将 canvas 转换为 Blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png', 1.0);
                });

                // 创建 FormData
                const formData = new FormData();
                formData.append('image', blob, `screenshot-${Date.now()}.png`);
                formData.append('title', title);
                formData.append('description', description);
                formData.append('timestamp', new Date().toISOString());

                // 上传到服务器
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('图片上传成功！', 'success');
                    
                    // 保存到本地存储以便查看
                    saveToLocalStorage(result);
                    
                    // 清空表单
                    document.getElementById('imageTitle').value = '';
                    document.getElementById('imageDescription').value = '';
                    
                    console.log('上传成功:', result);
                } else {
                    const errorText = await response.text();
                    throw new Error(`服务器错误: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('上传失败:', error);
                
                // 如果是网络错误，提供模拟上传选项
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showStatus('无法连接服务器，使用模拟上传', 'info');
                    await mockUpload(title, description);
                } else {
                    showStatus(`上传失败: ${error.message}`, 'error');
                }
            }
        }

        // 模拟上传（用于演示和测试）
        async function mockUpload(title, description) {
            // 模拟网络延迟
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const mockResult = {
                id: Date.now(),
                title: title,
                description: description,
                filename: `screenshot-${Date.now()}.png`,
                url: canvas.toDataURL(),
                size: Math.round(canvas.toDataURL().length * 0.75), // 估算文件大小
                uploadTime: new Date().toISOString(),
                status: 'success'
            };
            
            saveToLocalStorage(mockResult);
            showStatus('模拟上传成功！', 'success');
            
            // 清空表单
            document.getElementById('imageTitle').value = '';
            document.getElementById('imageDescription').value = '';
        }

        // 保存到本地存储
        function saveToLocalStorage(imageData) {
            let savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            savedImages.unshift(imageData); // 最新的放在前面
            
            // 限制保存数量（避免存储过多）
            if (savedImages.length > 50) {
                savedImages = savedImages.slice(0, 50);
            }
            
            localStorage.setItem('savedScreenshots', JSON.stringify(savedImages));
        }

        // 显示已保存的图片
        function showSavedImages() {
            const savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            
            if (savedImages.length === 0) {
                showStatus('暂无保存的图片', 'info');
                return;
            }

            // 创建模态窗口
            const modal = createImageGalleryModal(savedImages);
            document.body.appendChild(modal);
        }

        // 创建图片画廊模态窗口
        function createImageGalleryModal(images) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✕';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 15px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                cursor: pointer;
                font-size: 16px;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            const title = document.createElement('h2');
            title.textContent = `📁 已保存的图片 (${images.length}张)`;
            title.style.marginBottom = '20px';

            // 批量操作按钮
            const batchActions = document.createElement('div');
            batchActions.style.cssText = `
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            `;

            const exportAllBtn = document.createElement('button');
            exportAllBtn.textContent = '📦 批量导出';
            exportAllBtn.style.cssText = `
                padding: 8px 16px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            `;
            exportAllBtn.onclick = () => {
                document.body.removeChild(modal);
                exportAllImages();
            };

            const clearAllBtn = document.createElement('button');
            clearAllBtn.textContent = '🗑️ 清理所有';
            clearAllBtn.style.cssText = `
                padding: 8px 16px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            `;
            clearAllBtn.onclick = () => {
                if (confirm('确定要清理所有本地保存的图片吗？此操作不可恢复！')) {
                    localStorage.removeItem('savedScreenshots');
                    document.body.removeChild(modal);
                    showStatus('所有本地图片已清理', 'success');
                }
            };

            batchActions.appendChild(exportAllBtn);
            batchActions.appendChild(clearAllBtn);

            const gallery = document.createElement('div');
            gallery.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            `;

            images.forEach((image, index) => {
                const card = createImageCard(image, index);
                gallery.appendChild(card);
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(batchActions);
            modalContent.appendChild(gallery);
            modal.appendChild(modalContent);

            // 点击背景关闭
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };

            return modal;
        }

        // 创建图片卡片
        function createImageCard(image, index) {
            const card = document.createElement('div');
            card.style.cssText = `
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                background: #f8f9fa;
            `;

            const img = document.createElement('img');
            img.src = image.url;
            img.style.cssText = `
                width: 100%;
                max-height: 200px;
                object-fit: cover;
                border-radius: 4px;
                margin-bottom: 10px;
            `;

            const titleEl = document.createElement('h4');
            titleEl.textContent = image.title;
            titleEl.style.cssText = `
                margin: 0 0 5px 0;
                color: #495057;
            `;

            const info = document.createElement('div');
            info.style.cssText = `
                font-size: 12px;
                color: #6c757d;
                margin-bottom: 10px;
            `;
            
            const uploadTime = new Date(image.uploadTime).toLocaleString('zh-CN');
            info.innerHTML = `
                <div>📅 ${uploadTime}</div>
                <div>📏 ${Math.round(image.size / 1024)}KB</div>
                ${image.description ? `<div>📝 ${image.description}</div>` : ''}
            `;

            const actions = document.createElement('div');
            actions.style.cssText = `
                display: flex;
                gap: 5px;
                margin-top: 10px;
            `;

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '下载';
            downloadBtn.style.cssText = `
                flex: 1;
                padding: 5px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            `;
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.href = image.url;
                link.download = image.filename;
                link.click();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '删除';
            deleteBtn.style.cssText = `
                flex: 1;
                padding: 5px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            `;
            deleteBtn.onclick = () => {
                if (confirm('确定要删除这张图片吗？')) {
                    deleteImage(image.id);
                    card.remove();
                }
            };

            actions.appendChild(downloadBtn);
            actions.appendChild(deleteBtn);

            card.appendChild(img);
            card.appendChild(titleEl);
            card.appendChild(info);
            card.appendChild(actions);

            return card;
        }

        // 删除图片
        function deleteImage(imageId) {
            let savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            savedImages = savedImages.filter(img => img.id !== imageId);
            localStorage.setItem('savedScreenshots', JSON.stringify(savedImages));
            showStatus('图片已删除', 'success');
        }

        // 批量导出所有图片
        function exportAllImages() {
            const savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            
            if (savedImages.length === 0) {
                showStatus('没有可导出的图片', 'error');
                return;
            }

            if (savedImages.length === 1) {
                // 只有一张图片，直接下载
                const image = savedImages[0];
                const link = document.createElement('a');
                link.href = image.url;
                link.download = image.filename;
                link.click();
                showStatus('图片导出完成', 'success');
                return;
            }

            // 多张图片，逐个下载
            showStatus(`开始导出 ${savedImages.length} 张图片...`, 'info');
            
            let exportedCount = 0;
            const exportInterval = setInterval(() => {
                if (exportedCount >= savedImages.length) {
                    clearInterval(exportInterval);
                    showStatus(`批量导出完成！共导出 ${savedImages.length} 张图片`, 'success');
                    return;
                }

                const image = savedImages[exportedCount];
                const link = document.createElement('a');
                link.href = image.url;
                link.download = `${exportedCount + 1}-${image.filename}`;
                link.click();
                
                exportedCount++;
                showStatus(`正在导出第 ${exportedCount}/${savedImages.length} 张图片...`, 'info');
            }, 500); // 每500ms导出一张，避免浏览器限制
        }

        // 一键清理所有本地存储的图片
        function clearAllLocalImages() {
            if (confirm('确定要清理所有本地保存的图片吗？此操作不可恢复！')) {
                localStorage.removeItem('savedScreenshots');
                showStatus('所有本地图片已清理', 'success');
            }
        }

        function resetAll() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 重置画布尺寸
            canvas.width = 0;
            canvas.height = 0;
            
            // 重置界面
            canvas.style.display = 'none';
            document.getElementById('canvasPlaceholder').style.display = 'block';
            document.getElementById('canvasContainer').classList.remove('has-image');
            
            // 重置模式
            currentMode = 'none';
            document.getElementById('textControls').classList.remove('active');
            canvas.style.cursor = 'default';
            
            // 清空历史记录
            actionHistory = [];
            
            // 重置表单
            document.getElementById('textContent').value = '';
            document.getElementById('customSelector').value = '';
            
            showStatus('已重置所有设置', 'success');
        }
    </script>
</body>
</html>
