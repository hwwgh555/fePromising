<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆªå›¾å’Œå›¾åƒç¼–è¾‘å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 80vh;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .tool-section {
            margin-bottom: 30px;
        }

        .tool-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .form-group {
            margin: 10px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="color"] {
            height: 40px;
            padding: 2px;
        }

        .form-group input[type="range"] {
            margin: 10px 0;
        }

        .workspace {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .canvas-container {
            position: relative;
            margin: 20px 0;
            border: 2px dashed #ced4da;
            border-radius: 8px;
            background: #f8f9fa;
            min-width: 800px;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container.has-image {
            border-style: solid;
            border-color: #667eea;
            background: white;
        }

        #editCanvas {
            max-width: 100%;
            max-height: 70vh;
            cursor: crosshair;
            border-radius: 4px;
        }

        .canvas-placeholder {
            text-align: center;
            color: #6c757d;
            font-size: 1.2em;
        }

        .demo-content {
            margin: 20px 0;
            padding: 30px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            text-align: center;
        }

        .demo-table {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .demo-table th,
        .demo-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .demo-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .demo-table tr:hover {
            background: #f8f9fa;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .status.show {
            transform: translateX(0);
        }

        .status.success {
            background: #28a745;
        }

        .status.error {
            background: #dc3545;
        }

        .status.info {
            background: #17a2b8;
        }

        .text-controls {
            display: none;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
        }

        .text-controls.active {
            display: block;
        }

        .color-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-row input[type="color"] {
            width: 50px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container span {
            min-width: 30px;
            font-weight: 500;
        }

        .target-selector {
            border: 3px solid #ff6b6b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: white;
            animation: highlight 2s infinite;
        }

        @keyframes highlight {
            0%, 100% { border-color: #ff6b6b; }
            50% { border-color: #4ecdc4; }
        }

        .screenshot-preview {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ æˆªå›¾å’Œå›¾åƒç¼–è¾‘å·¥å…·</h1>
            <p>æ”¯æŒHTMLå…ƒç´ æˆªå›¾ã€æ·»åŠ æ–‡å­—ã€ç»˜åˆ¶å›¾å½¢ç­‰åŠŸèƒ½</p>
        </div>

        <div class="main-content">
            <!-- ä¾§è¾¹æ å·¥å…·é¢æ¿ -->
            <div class="sidebar">
                <!-- æˆªå›¾å·¥å…· -->
                <div class="tool-section">
                    <h3>ğŸ“¸ æˆªå›¾å·¥å…·</h3>
                    <button class="btn" onclick="captureFullPage()">æˆªå–æ•´ä¸ªé¡µé¢</button>
                    <button class="btn" onclick="captureTargetElement()">æˆªå–ç›®æ ‡å…ƒç´ </button>
                    <button class="btn" onclick="captureCustomElement()">é€‰æ‹©å…ƒç´ æˆªå›¾</button>
                    
                    <div class="form-group">
                        <label>è‡ªå®šä¹‰é€‰æ‹©å™¨:</label>
                        <input type="text" id="customSelector" placeholder="ä¾‹å¦‚: #myDiv, .className">
                    </div>
                    
                    <div class="form-group">
                        <label>æˆªå›¾è´¨é‡:</label>
                        <select id="screenshotQuality">
                            <option value="1">æ ‡å‡† (1x)</option>
                            <option value="2">é«˜æ¸… (2x)</option>
                            <option value="3">è¶…é«˜æ¸… (3x)</option>
                        </select>
                    </div>
                </div>

                <!-- æ–‡å­—ç¼–è¾‘å·¥å…· -->
                <div class="tool-section">
                    <h3>âœï¸ æ–‡å­—å·¥å…·</h3>
                    <button class="btn" onclick="enableTextMode()">æ·»åŠ æ–‡å­—</button>
                    
                    <div class="text-controls" id="textControls">
                        <div class="form-group">
                            <label>æ–‡å­—å†…å®¹:</label>
                            <textarea id="textContent" rows="3" placeholder="è¾“å…¥è¦æ·»åŠ çš„æ–‡å­—"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>å­—ä½“å¤§å°:</label>
                            <div class="slider-container">
                                <input type="range" id="fontSize" min="12" max="100" value="24">
                                <span id="fontSizeValue">24px</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å­—ä½“æ ·å¼:</label>
                            <select id="fontFamily">
                                <option value="Arial">Arial</option>
                                <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                                <option value="SimHei">é»‘ä½“</option>
                                <option value="SimSun">å®‹ä½“</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>æ–‡å­—é¢œè‰²:</label>
                            <div class="color-row">
                                <input type="color" id="textColor" value="#000000">
                                <span>æ–‡å­—</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>èƒŒæ™¯é¢œè‰²:</label>
                            <div class="color-row">
                                <input type="color" id="textBgColor" value="#ffffff">
                                <input type="checkbox" id="transparentBg" checked>
                                <span>é€æ˜</span>
                            </div>
                        </div>
                        
                        <button class="btn secondary" onclick="disableTextMode()">å–æ¶ˆæ–‡å­—æ¨¡å¼</button>
                    </div>
                </div>

                <!-- ç»˜åˆ¶å·¥å…· -->
                <div class="tool-section">
                    <h3>ğŸ¨ ç»˜åˆ¶å·¥å…·</h3>
                    <button class="btn" onclick="enableDrawMode()">è‡ªç”±ç»˜åˆ¶</button>
                    <button class="btn" onclick="enableRectMode()">ç»˜åˆ¶çŸ©å½¢</button>
                    <button class="btn" onclick="enableCircleMode()">ç»˜åˆ¶åœ†å½¢</button>
                    
                    <div class="form-group">
                        <label>ç”»ç¬”é¢œè‰²:</label>
                        <input type="color" id="drawColor" value="#ff0000">
                    </div>
                    
                    <div class="form-group">
                        <label>ç”»ç¬”ç²—ç»†:</label>
                        <div class="slider-container">
                            <input type="range" id="drawWidth" min="1" max="20" value="3">
                            <span id="drawWidthValue">3px</span>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œå·¥å…· -->
                <div class="tool-section">
                    <h3>ğŸ”§ æ“ä½œå·¥å…·</h3>
                    <button class="btn secondary" onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
                    <button class="btn secondary" onclick="undoLastAction()">æ’¤é”€æ“ä½œ</button>
                    <button class="btn" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
                    <button class="btn" onclick="uploadToServer()">ä¸Šä¼ åˆ°æœåŠ¡å™¨</button>
                    <button class="btn secondary" onclick="showSavedImages()">æŸ¥çœ‹å·²ä¿å­˜</button>
                    <button class="btn secondary" onclick="exportAllImages()">æ‰¹é‡å¯¼å‡º</button>
                    <button class="btn danger" onclick="resetAll()">é‡ç½®æ‰€æœ‰</button>
                </div>

                <!-- æœåŠ¡å™¨è®¾ç½® -->
                <div class="tool-section">
                    <h3>ğŸŒ æœåŠ¡å™¨è®¾ç½®</h3>
                    <div class="form-group">
                        <label>ä¸Šä¼ åœ°å€:</label>
                        <input type="text" id="uploadUrl" value="http://localhost:3000/api/upload-image" placeholder="è¾“å…¥ä¸Šä¼ APIåœ°å€">
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            ğŸ’¡ æœ¬åœ°æµ‹è¯•: http://localhost:3000/api/upload-image<br>
                            ğŸŒ ç”Ÿäº§ç¯å¢ƒ: https://your-domain.com/api/upload-image
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å›¾ç‰‡æ ‡é¢˜:</label>
                        <input type="text" id="imageTitle" placeholder="ä¸ºå›¾ç‰‡æ·»åŠ æ ‡é¢˜">
                    </div>
                    
                    <div class="form-group">
                        <label>å›¾ç‰‡æè¿°:</label>
                        <textarea id="imageDescription" rows="3" placeholder="æ·»åŠ å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>
            </div>

            <!-- ä¸»å·¥ä½œåŒº -->
            <div class="workspace">
                <!-- ç”»å¸ƒå®¹å™¨ -->
                <div class="canvas-container" id="canvasContainer">
                    <div class="canvas-placeholder" id="canvasPlaceholder">
                        <h3>ğŸ¯ ç‚¹å‡»å·¦ä¾§æˆªå›¾æŒ‰é’®å¼€å§‹</h3>
                        <p>æˆªå›¾åå¯ä»¥åœ¨æ­¤å¤„è¿›è¡Œç¼–è¾‘</p>
                    </div>
                    <canvas id="editCanvas" style="display: none;"></canvas>
                </div>

                <!-- æ¼”ç¤ºå†…å®¹åŒºåŸŸ -->
                <div class="demo-content target-selector" id="targetElement">
                    <h2>ğŸ¯ ç›®æ ‡æˆªå›¾åŒºåŸŸ</h2>
                    <p>è¿™æ˜¯ä¸€ä¸ªç”¨äºæ¼”ç¤ºæˆªå›¾åŠŸèƒ½çš„åŒºåŸŸ</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="width: 100px; height: 100px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); margin: 0 auto; border-radius: 50%;"></div>
                    </div>
                    
                    <table class="demo-table">
                        <thead>
                            <tr>
                                <th>åŠŸèƒ½</th>
                                <th>çŠ¶æ€</th>
                                <th>æè¿°</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>HTMLæˆªå›¾</td>
                                <td>âœ… æ”¯æŒ</td>
                                <td>å¯æˆªå–ä»»æ„HTMLå…ƒç´ </td>
                            </tr>
                            <tr>
                                <td>æ·»åŠ æ–‡å­—</td>
                                <td>âœ… æ”¯æŒ</td>
                                <td>æ”¯æŒè‡ªå®šä¹‰å­—ä½“å’Œé¢œè‰²</td>
                            </tr>
                            <tr>
                                <td>ç»˜åˆ¶å›¾å½¢</td>
                                <td>âœ… æ”¯æŒ</td>
                                <td>æ”¯æŒè‡ªç”±ç»˜åˆ¶å’Œå‡ ä½•å›¾å½¢</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div class="status" id="statusMsg"></div>

    <!-- html2canvas åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let canvas, ctx;
        let isDrawing = false;
        let currentMode = 'none'; // none, text, draw, rect, circle
        let startX, startY;
        let actionHistory = [];
        let tempCanvas, tempCtx;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('editCanvas');
            ctx = canvas.getContext('2d');
            
            // åˆ›å»ºä¸´æ—¶ç”»å¸ƒç”¨äºé¢„è§ˆ
            tempCanvas = document.createElement('canvas');
            tempCtx = tempCanvas.getContext('2d');
            
            setupEventListeners();
            updateSliderValues();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç”»å¸ƒäº‹ä»¶
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleCanvasClick);
            
            // æ»‘å—äº‹ä»¶
            document.getElementById('fontSize').addEventListener('input', updateSliderValues);
            document.getElementById('drawWidth').addEventListener('input', updateSliderValues);
        }

        // æ›´æ–°æ»‘å—æ˜¾ç¤ºå€¼
        function updateSliderValues() {
            const fontSize = document.getElementById('fontSize').value;
            const drawWidth = document.getElementById('drawWidth').value;
            
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
            document.getElementById('drawWidthValue').textContent = drawWidth + 'px';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMsg');
            statusEl.textContent = message;
            statusEl.className = `status ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // æˆªå›¾åŠŸèƒ½
        async function captureFullPage() {
            try {
                showStatus('æ­£åœ¨æˆªå–æ•´ä¸ªé¡µé¢...', 'info');
                
                const scale = parseInt(document.getElementById('screenshotQuality').value);
                const captureCanvas = await html2canvas(document.body, {
                    backgroundColor: '#ffffff',
                    scale: scale,
                    useCORS: true,
                    logging: false
                });
                
                loadImageToEditor(captureCanvas);
                showStatus('é¡µé¢æˆªå›¾å®Œæˆï¼', 'success');
            } catch (error) {
                showStatus('æˆªå›¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function captureTargetElement() {
            try {
                showStatus('æ­£åœ¨æˆªå–ç›®æ ‡å…ƒç´ ...', 'info');
                
                const targetEl = document.getElementById('targetElement');
                const scale = parseInt(document.getElementById('screenshotQuality').value);
                
                const captureCanvas = await html2canvas(targetEl, {
                    backgroundColor: '#ffffff',
                    scale: scale,
                    useCORS: true,
                    logging: false
                });
                
                loadImageToEditor(captureCanvas);
                showStatus('ç›®æ ‡å…ƒç´ æˆªå›¾å®Œæˆï¼', 'success');
            } catch (error) {
                showStatus('æˆªå›¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function captureCustomElement() {
            try {
                const selector = document.getElementById('customSelector').value.trim();
                if (!selector) {
                    showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„é€‰æ‹©å™¨', 'error');
                    return;
                }
                
                const element = document.querySelector(selector);
                if (!element) {
                    showStatus('æ‰¾ä¸åˆ°æŒ‡å®šçš„å…ƒç´ ', 'error');
                    return;
                }
                
                showStatus('æ­£åœ¨æˆªå–è‡ªå®šä¹‰å…ƒç´ ...', 'info');
                
                const scale = parseInt(document.getElementById('screenshotQuality').value);
                const captureCanvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: scale,
                    useCORS: true,
                    logging: false
                });
                
                loadImageToEditor(captureCanvas);
                showStatus('è‡ªå®šä¹‰å…ƒç´ æˆªå›¾å®Œæˆï¼', 'success');
            } catch (error) {
                showStatus('æˆªå›¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å°†å›¾ç‰‡åŠ è½½åˆ°ç¼–è¾‘å™¨
        function loadImageToEditor(sourceCanvas) {
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = sourceCanvas.width;
            canvas.height = sourceCanvas.height;
            
            // è®¾ç½®ä¸´æ—¶ç”»å¸ƒå°ºå¯¸
            tempCanvas.width = sourceCanvas.width;
            tempCanvas.height = sourceCanvas.height;
            
            // æ¸…ç©ºå¹¶ç»˜åˆ¶æˆªå›¾
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            saveToHistory();
            
            // æ˜¾ç¤ºç”»å¸ƒï¼Œéšè—å ä½ç¬¦
            document.getElementById('canvasPlaceholder').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('canvasContainer').classList.add('has-image');
        }

        // æ–‡å­—æ¨¡å¼
        function enableTextMode() {
            currentMode = 'text';
            document.getElementById('textControls').classList.add('active');
            canvas.style.cursor = 'text';
            showStatus('ç‚¹å‡»ç”»å¸ƒæ·»åŠ æ–‡å­—', 'info');
        }

        function disableTextMode() {
            currentMode = 'none';
            document.getElementById('textControls').classList.remove('active');
            canvas.style.cursor = 'default';
        }

        // ç»˜åˆ¶æ¨¡å¼
        function enableDrawMode() {
            currentMode = 'draw';
            canvas.style.cursor = 'crosshair';
            showStatus('è‡ªç”±ç»˜åˆ¶æ¨¡å¼å·²å¯ç”¨', 'info');
        }

        function enableRectMode() {
            currentMode = 'rect';
            canvas.style.cursor = 'crosshair';
            showStatus('çŸ©å½¢ç»˜åˆ¶æ¨¡å¼å·²å¯ç”¨', 'info');
        }

        function enableCircleMode() {
            currentMode = 'circle';
            canvas.style.cursor = 'crosshair';
            showStatus('åœ†å½¢ç»˜åˆ¶æ¨¡å¼å·²å¯ç”¨', 'info');
        }

        // ç”»å¸ƒäº‹ä»¶å¤„ç†
        function handleCanvasClick(e) {
            if (currentMode === 'text') {
                addTextAtPosition(e);
            }
        }

        function handleMouseDown(e) {
            if (currentMode === 'draw' || currentMode === 'rect' || currentMode === 'circle') {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (canvas.width / rect.width);
                startY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                if (currentMode === 'draw') {
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                }
            }
        }

        function handleMouseMove(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const currentY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            if (currentMode === 'draw') {
                // è‡ªç”±ç»˜åˆ¶
                ctx.strokeStyle = document.getElementById('drawColor').value;
                ctx.lineWidth = parseInt(document.getElementById('drawWidth').value);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);
            } else if (currentMode === 'rect' || currentMode === 'circle') {
                // é¢„è§ˆå‡ ä½•å›¾å½¢
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(canvas, 0, 0);
                
                tempCtx.strokeStyle = document.getElementById('drawColor').value;
                tempCtx.lineWidth = parseInt(document.getElementById('drawWidth').value);
                
                if (currentMode === 'rect') {
                    const width = currentX - startX;
                    const height = currentY - startY;
                    tempCtx.strokeRect(startX, startY, width, height);
                } else if (currentMode === 'circle') {
                    const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    tempCtx.beginPath();
                    tempCtx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    tempCtx.stroke();
                }
                
                // ä¸´æ—¶æ˜¾ç¤ºé¢„è§ˆ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(tempCanvas, 0, 0);
            }
        }

        function handleMouseUp(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (currentMode === 'rect' || currentMode === 'circle') {
                const rect = canvas.getBoundingClientRect();
                const endX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const endY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                // æ¢å¤åŸå›¾
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(tempCanvas, 0, 0);
                
                // ç»˜åˆ¶æœ€ç»ˆå›¾å½¢
                ctx.strokeStyle = document.getElementById('drawColor').value;
                ctx.lineWidth = parseInt(document.getElementById('drawWidth').value);
                
                if (currentMode === 'rect') {
                    const width = endX - startX;
                    const height = endY - startY;
                    ctx.strokeRect(startX, startY, width, height);
                } else if (currentMode === 'circle') {
                    const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    ctx.beginPath();
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                }
                
                saveToHistory();
            } else if (currentMode === 'draw') {
                saveToHistory();
            }
        }

        // æ·»åŠ æ–‡å­—
        function addTextAtPosition(e) {
            const text = document.getElementById('textContent').value.trim();
            if (!text) {
                showStatus('è¯·è¾“å…¥æ–‡å­—å†…å®¹', 'error');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const fontFamily = document.getElementById('fontFamily').value;
            const textColor = document.getElementById('textColor').value;
            const bgColor = document.getElementById('textBgColor').value;
            const transparent = document.getElementById('transparentBg').checked;
            
            // è®¾ç½®å­—ä½“
            ctx.font = `${fontSize}px ${fontFamily}`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            // æµ‹é‡æ–‡å­—å°ºå¯¸
            const metrics = ctx.measureText(text);
            const textWidth = metrics.width;
            const textHeight = fontSize;
            
            // ç»˜åˆ¶èƒŒæ™¯ï¼ˆå¦‚æœä¸é€æ˜ï¼‰
            if (!transparent) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(x - 5, y - 5, textWidth + 10, textHeight + 10);
            }
            
            // ç»˜åˆ¶æ–‡å­—
            ctx.fillStyle = textColor;
            ctx.fillText(text, x, y);
            
            saveToHistory();
            showStatus('æ–‡å­—æ·»åŠ æˆåŠŸ', 'success');
        }

        // å†å²è®°å½•ç®¡ç†
        function saveToHistory() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            actionHistory.push(imageData);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (actionHistory.length > 10) {
                actionHistory.shift();
            }
        }

        function undoLastAction() {
            if (actionHistory.length > 1) {
                actionHistory.pop(); // ç§»é™¤å½“å‰çŠ¶æ€
                const previousState = actionHistory[actionHistory.length - 1];
                ctx.putImageData(previousState, 0, 0);
                showStatus('å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ', 'success');
            } else {
                showStatus('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function clearCanvas() {
            if (canvas.width === 0) {
                showStatus('æ²¡æœ‰å¯æ¸…ç©ºçš„å†…å®¹', 'error');
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            saveToHistory();
            showStatus('ç”»å¸ƒå·²æ¸…ç©º', 'success');
        }

        function downloadImage() {
            if (canvas.width === 0) {
                showStatus('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `edited-screenshot-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showStatus('å›¾ç‰‡ä¸‹è½½æˆåŠŸ', 'success');
        }

        // ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
        async function uploadToServer() {
            if (canvas.width === 0) {
                showStatus('æ²¡æœ‰å¯ä¸Šä¼ çš„å›¾ç‰‡', 'error');
                return;
            }

            const uploadUrl = document.getElementById('uploadUrl').value.trim();
            const title = document.getElementById('imageTitle').value.trim();
            const description = document.getElementById('imageDescription').value.trim();

            if (!uploadUrl) {
                showStatus('è¯·è®¾ç½®ä¸Šä¼ åœ°å€', 'error');
                return;
            }

            if (!title) {
                showStatus('è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');

                // å°† canvas è½¬æ¢ä¸º Blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png', 1.0);
                });

                // åˆ›å»º FormData
                const formData = new FormData();
                formData.append('image', blob, `screenshot-${Date.now()}.png`);
                formData.append('title', title);
                formData.append('description', description);
                formData.append('timestamp', new Date().toISOString());

                // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä»¥ä¾¿æŸ¥çœ‹
                    saveToLocalStorage(result);
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('imageTitle').value = '';
                    document.getElementById('imageDescription').value = '';
                    
                    console.log('ä¸Šä¼ æˆåŠŸ:', result);
                } else {
                    const errorText = await response.text();
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ¨¡æ‹Ÿä¸Šä¼ é€‰é¡¹
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showStatus('æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿä¸Šä¼ ', 'info');
                    await mockUpload(title, description);
                } else {
                    showStatus(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // æ¨¡æ‹Ÿä¸Šä¼ ï¼ˆç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•ï¼‰
        async function mockUpload(title, description) {
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const mockResult = {
                id: Date.now(),
                title: title,
                description: description,
                filename: `screenshot-${Date.now()}.png`,
                url: canvas.toDataURL(),
                size: Math.round(canvas.toDataURL().length * 0.75), // ä¼°ç®—æ–‡ä»¶å¤§å°
                uploadTime: new Date().toISOString(),
                status: 'success'
            };
            
            saveToLocalStorage(mockResult);
            showStatus('æ¨¡æ‹Ÿä¸Šä¼ æˆåŠŸï¼', 'success');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('imageTitle').value = '';
            document.getElementById('imageDescription').value = '';
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage(imageData) {
            let savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            savedImages.unshift(imageData); // æœ€æ–°çš„æ”¾åœ¨å‰é¢
            
            // é™åˆ¶ä¿å­˜æ•°é‡ï¼ˆé¿å…å­˜å‚¨è¿‡å¤šï¼‰
            if (savedImages.length > 50) {
                savedImages = savedImages.slice(0, 50);
            }
            
            localStorage.setItem('savedScreenshots', JSON.stringify(savedImages));
        }

        // æ˜¾ç¤ºå·²ä¿å­˜çš„å›¾ç‰‡
        function showSavedImages() {
            const savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            
            if (savedImages.length === 0) {
                showStatus('æš‚æ— ä¿å­˜çš„å›¾ç‰‡', 'info');
                return;
            }

            // åˆ›å»ºæ¨¡æ€çª—å£
            const modal = createImageGalleryModal(savedImages);
            document.body.appendChild(modal);
        }

        // åˆ›å»ºå›¾ç‰‡ç”»å»Šæ¨¡æ€çª—å£
        function createImageGalleryModal(images) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                position: relative;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âœ•';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 15px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                cursor: pointer;
                font-size: 16px;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            const title = document.createElement('h2');
            title.textContent = `ğŸ“ å·²ä¿å­˜çš„å›¾ç‰‡ (${images.length}å¼ )`;
            title.style.marginBottom = '20px';

            // æ‰¹é‡æ“ä½œæŒ‰é’®
            const batchActions = document.createElement('div');
            batchActions.style.cssText = `
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            `;

            const exportAllBtn = document.createElement('button');
            exportAllBtn.textContent = 'ğŸ“¦ æ‰¹é‡å¯¼å‡º';
            exportAllBtn.style.cssText = `
                padding: 8px 16px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            `;
            exportAllBtn.onclick = () => {
                document.body.removeChild(modal);
                exportAllImages();
            };

            const clearAllBtn = document.createElement('button');
            clearAllBtn.textContent = 'ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰';
            clearAllBtn.style.cssText = `
                padding: 8px 16px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            `;
            clearAllBtn.onclick = () => {
                if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æœ¬åœ°ä¿å­˜çš„å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.removeItem('savedScreenshots');
                    document.body.removeChild(modal);
                    showStatus('æ‰€æœ‰æœ¬åœ°å›¾ç‰‡å·²æ¸…ç†', 'success');
                }
            };

            batchActions.appendChild(exportAllBtn);
            batchActions.appendChild(clearAllBtn);

            const gallery = document.createElement('div');
            gallery.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            `;

            images.forEach((image, index) => {
                const card = createImageCard(image, index);
                gallery.appendChild(card);
            });

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(batchActions);
            modalContent.appendChild(gallery);
            modal.appendChild(modalContent);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };

            return modal;
        }

        // åˆ›å»ºå›¾ç‰‡å¡ç‰‡
        function createImageCard(image, index) {
            const card = document.createElement('div');
            card.style.cssText = `
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                background: #f8f9fa;
            `;

            const img = document.createElement('img');
            img.src = image.url;
            img.style.cssText = `
                width: 100%;
                max-height: 200px;
                object-fit: cover;
                border-radius: 4px;
                margin-bottom: 10px;
            `;

            const titleEl = document.createElement('h4');
            titleEl.textContent = image.title;
            titleEl.style.cssText = `
                margin: 0 0 5px 0;
                color: #495057;
            `;

            const info = document.createElement('div');
            info.style.cssText = `
                font-size: 12px;
                color: #6c757d;
                margin-bottom: 10px;
            `;
            
            const uploadTime = new Date(image.uploadTime).toLocaleString('zh-CN');
            info.innerHTML = `
                <div>ğŸ“… ${uploadTime}</div>
                <div>ğŸ“ ${Math.round(image.size / 1024)}KB</div>
                ${image.description ? `<div>ğŸ“ ${image.description}</div>` : ''}
            `;

            const actions = document.createElement('div');
            actions.style.cssText = `
                display: flex;
                gap: 5px;
                margin-top: 10px;
            `;

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'ä¸‹è½½';
            downloadBtn.style.cssText = `
                flex: 1;
                padding: 5px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            `;
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.href = image.url;
                link.download = image.filename;
                link.click();
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.style.cssText = `
                flex: 1;
                padding: 5px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            `;
            deleteBtn.onclick = () => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                    deleteImage(image.id);
                    card.remove();
                }
            };

            actions.appendChild(downloadBtn);
            actions.appendChild(deleteBtn);

            card.appendChild(img);
            card.appendChild(titleEl);
            card.appendChild(info);
            card.appendChild(actions);

            return card;
        }

        // åˆ é™¤å›¾ç‰‡
        function deleteImage(imageId) {
            let savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            savedImages = savedImages.filter(img => img.id !== imageId);
            localStorage.setItem('savedScreenshots', JSON.stringify(savedImages));
            showStatus('å›¾ç‰‡å·²åˆ é™¤', 'success');
        }

        // æ‰¹é‡å¯¼å‡ºæ‰€æœ‰å›¾ç‰‡
        function exportAllImages() {
            const savedImages = JSON.parse(localStorage.getItem('savedScreenshots') || '[]');
            
            if (savedImages.length === 0) {
                showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡', 'error');
                return;
            }

            if (savedImages.length === 1) {
                // åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œç›´æ¥ä¸‹è½½
                const image = savedImages[0];
                const link = document.createElement('a');
                link.href = image.url;
                link.download = image.filename;
                link.click();
                showStatus('å›¾ç‰‡å¯¼å‡ºå®Œæˆ', 'success');
                return;
            }

            // å¤šå¼ å›¾ç‰‡ï¼Œé€ä¸ªä¸‹è½½
            showStatus(`å¼€å§‹å¯¼å‡º ${savedImages.length} å¼ å›¾ç‰‡...`, 'info');
            
            let exportedCount = 0;
            const exportInterval = setInterval(() => {
                if (exportedCount >= savedImages.length) {
                    clearInterval(exportInterval);
                    showStatus(`æ‰¹é‡å¯¼å‡ºå®Œæˆï¼å…±å¯¼å‡º ${savedImages.length} å¼ å›¾ç‰‡`, 'success');
                    return;
                }

                const image = savedImages[exportedCount];
                const link = document.createElement('a');
                link.href = image.url;
                link.download = `${exportedCount + 1}-${image.filename}`;
                link.click();
                
                exportedCount++;
                showStatus(`æ­£åœ¨å¯¼å‡ºç¬¬ ${exportedCount}/${savedImages.length} å¼ å›¾ç‰‡...`, 'info');
            }, 500); // æ¯500mså¯¼å‡ºä¸€å¼ ï¼Œé¿å…æµè§ˆå™¨é™åˆ¶
        }

        // ä¸€é”®æ¸…ç†æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„å›¾ç‰‡
        function clearAllLocalImages() {
            if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æœ¬åœ°ä¿å­˜çš„å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('savedScreenshots');
                showStatus('æ‰€æœ‰æœ¬åœ°å›¾ç‰‡å·²æ¸…ç†', 'success');
            }
        }

        function resetAll() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // é‡ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = 0;
            canvas.height = 0;
            
            // é‡ç½®ç•Œé¢
            canvas.style.display = 'none';
            document.getElementById('canvasPlaceholder').style.display = 'block';
            document.getElementById('canvasContainer').classList.remove('has-image');
            
            // é‡ç½®æ¨¡å¼
            currentMode = 'none';
            document.getElementById('textControls').classList.remove('active');
            canvas.style.cursor = 'default';
            
            // æ¸…ç©ºå†å²è®°å½•
            actionHistory = [];
            
            // é‡ç½®è¡¨å•
            document.getElementById('textContent').value = '';
            document.getElementById('customSelector').value = '';
            
            showStatus('å·²é‡ç½®æ‰€æœ‰è®¾ç½®', 'success');
        }
    </script>
</body>
</html>
